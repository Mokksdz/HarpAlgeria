generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                    String           @id @default(cuid())
  slug                  String           @unique
  nameFr                String
  nameAr                String
  descriptionFr         String
  descriptionAr         String
  price                 Decimal
  images                String
  sizes                 String
  colors                String
  stock                 Int              @default(0)
  isActive              Boolean          @default(true)
  showSizeGuide         Boolean          @default(true)
  freeShipping          Boolean          @default(false)
  freeShippingThreshold Decimal?         @default(0)
  collectionId          String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  promoEnd              DateTime?
  promoPrice            Decimal?
  promoStart            DateTime?
  orderItems            OrderItem[]
  collection            Collection?      @relation(fields: [collectionId], references: [id])
  variants              ProductVariant[]
  wishlistItems         WishlistItem[]

  @@index([collectionId])
  @@index([slug])
  @@index([isActive])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  size      String
  color     String
  stock     Int     @default(0)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size, color])
  @@index([productId])
}

model Collection {
  id          String    @id @default(cuid())
  slug        String    @unique
  nameFr      String
  nameAr      String
  description String?
  image       String?
  budget      Decimal   @default(0)
  budgetUsed  Decimal   @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  charges     Charge[]
  models      Model[]
  products    Product[]

  @@index([slug])
  @@index([createdAt])
}

model Order {
  id               String      @id @default(cuid())
  orderNumber      String      @unique @default(cuid())
  customerName     String
  customerPhone    String
  customerAddress  String
  customerCity     String
  customerWilaya   String
  deliveryProvider String?
  deliveryType     String?
  shippingPrice    Decimal     @default(0)
  trackingNumber   String?
  trackingStatus   String?
  stopDeskId       Int?        // Bug #13: Persist stop desk ID from checkout
  subtotal         Decimal
  total            Decimal
  status           String      @default("PENDING")
  stockReserved    Boolean     @default(false)
  userId           String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  user             User?       @relation(fields: [userId], references: [id])
  items            OrderItem[]

  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([userId])
  @@index([trackingNumber])    // Bug #36: Index for webhook/tracking lookups
  @@index([deliveryProvider])  // Bug #36: Index for cron sync queries
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String?
  modelId     String?
  productName String
  size        String
  color       String
  quantity    Int
  unitPrice   Decimal
  totalPrice  Decimal
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([modelId])
}

model Supplier {
  id           String            @id @default(cuid())
  code         String            @unique
  name         String
  contact      String?
  phone        String?
  email        String?
  address      String?
  city         String?
  country      String            @default("Algérie")
  taxId        String?
  paymentTerms String?
  notes        String?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  items        InventoryItem[]
  purchases    Purchase[]
  advances     SupplierAdvance[]

  @@index([code])
  @@index([name])
  @@index([isActive])
}

model Purchase {
  id             String            @id @default(cuid())
  purchaseNumber String            @unique
  supplierId     String
  invoiceNumber  String?
  invoiceDate    DateTime?
  orderDate      DateTime          @default(now())
  expectedDate   DateTime?
  receivedDate   DateTime?
  subtotal       Decimal           @default(0)
  taxAmount      Decimal           @default(0)
  shippingCost   Decimal           @default(0)
  totalAmount    Decimal           @default(0)
  currency       String            @default("DZD")
  advanceApplied Decimal           @default(0)
  amountDue      Decimal           @default(0)
  status         String            @default("DRAFT")
  receivedBy     String?
  notes          String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  supplier       Supplier          @relation(fields: [supplierId], references: [id])
  advances       PurchaseAdvance[]
  items          PurchaseItem[]

  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@index([purchaseNumber])
  @@index([receivedDate])
}

model PurchaseItem {
  id               String        @id @default(cuid())
  purchaseId       String
  inventoryItemId  String
  quantityOrdered  Decimal
  quantityReceived Decimal       @default(0)
  unit             String
  unitPrice        Decimal
  totalPrice       Decimal
  allocations      String?
  createdAt        DateTime      @default(now())
  inventoryItem    InventoryItem @relation(fields: [inventoryItemId], references: [id])
  purchase         Purchase      @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([inventoryItemId])
}

model SupplierAdvance {
  id              String            @id @default(cuid())
  advanceNumber   String            @unique
  supplierId      String
  amount          Decimal
  amountUsed      Decimal           @default(0)
  amountRemaining Decimal           @default(0)
  paymentDate     DateTime          @default(now())
  paymentMethod   String?
  reference       String?
  status          String            @default("PENDING")
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  applications    PurchaseAdvance[]
  supplier        Supplier          @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([status])
  @@index([advanceNumber])
}

model PurchaseAdvance {
  id         String          @id @default(cuid())
  purchaseId String
  advanceId  String
  amount     Decimal
  appliedAt  DateTime        @default(now())
  appliedBy  String?
  advance    SupplierAdvance @relation(fields: [advanceId], references: [id])
  purchase   Purchase        @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@unique([purchaseId, advanceId])
  @@index([purchaseId])
  @@index([advanceId])
}

model InventoryItem {
  id             String                 @id @default(cuid())
  sku            String                 @unique
  name           String
  type           String
  unit           String
  quantity       Decimal                @default(0)
  reserved       Decimal                @default(0)
  available      Decimal                @default(0)
  averageCost    Decimal                @default(0)
  lastCost       Decimal                @default(0)
  totalValue     Decimal                @default(0)
  color          String?
  width          Decimal?
  composition    String?
  location       String?
  threshold      Decimal?
  supplierId     String?
  notes          String?
  isActive       Boolean                @default(true)
  lastReceivedAt DateTime?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  consumptions   BatchConsumption[]
  bomItems       BomItem[]
  supplier       Supplier?              @relation(fields: [supplierId], references: [id])
  transactions   InventoryTransaction[]
  finishedModels Model[]                @relation("FinishedProduct")
  purchaseItems  PurchaseItem[]

  @@index([sku])
  @@index([type])
  @@index([supplierId])
  @@index([isActive])
  @@index([location])
  @@index([lastReceivedAt])
}

model InventoryTransaction {
  id              String        @id @default(cuid())
  inventoryItemId String
  direction       String
  type            String
  quantity        Decimal
  unitCost        Decimal?
  balanceBefore   Decimal
  balanceAfter    Decimal
  valueBefore     Decimal?
  valueAfter      Decimal?
  avgCostBefore   Decimal?
  avgCostAfter    Decimal?
  referenceType   String?
  referenceId     String?
  reason          String?
  notes           String?
  createdBy       String?
  createdAt       DateTime      @default(now())
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([inventoryItemId])
  @@index([direction])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
}

model Model {
  id              String            @id @default(cuid())
  sku             String            @unique
  name            String
  description     String?
  image           String?
  productId       String?
  inventoryItemId String?
  collectionId    String?
  targetPrice     Decimal?
  sellingPrice    Decimal?
  estimatedUnits  Int               @default(100)
  producedUnits   Int               @default(0)
  laborCost       Decimal           @default(0)
  packagingCost   Decimal           @default(0)
  otherCost       Decimal           @default(0)
  returnMargin    Decimal           @default(150)
  packagingBox    Decimal           @default(0)
  packagingBag    Decimal           @default(0)
  packagingLabel  Decimal           @default(0)
  packagingTag    Decimal           @default(0)
  packagingCard   Decimal           @default(0)
  packagingOther  Decimal           @default(0)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  bom             BomItem[]
  charges         Charge[]
  snapshots       CostSnapshot[]
  collection      Collection?       @relation(fields: [collectionId], references: [id])
  inventoryItem   InventoryItem?    @relation("FinishedProduct", fields: [inventoryItemId], references: [id])
  batches         ProductionBatch[]

  @@index([sku])
  @@index([collectionId])
  @@index([productId])
  @@index([isActive])
}

model BomItem {
  id              String        @id @default(cuid())
  modelId         String
  inventoryItemId String
  quantity        Decimal
  wasteFactor     Decimal       @default(1.05)
  unitCost        Decimal?
  totalCost       Decimal?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  model           Model         @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, inventoryItemId])
  @@index([modelId])
  @@index([inventoryItemId])
}

model Charge {
  id           String      @id @default(cuid())
  chargeNumber String      @unique
  category     String
  subcategory  String?
  description  String
  amount       Decimal
  currency     String      @default("DZD")
  date         DateTime    @default(now())
  scope        String      @default("GLOBAL")
  collectionId String?
  modelId      String?
  isAllocated  Boolean     @default(false)
  allocations  String?
  vendor       String?
  invoiceRef   String?
  campaign     String?
  platform     String?
  notes        String?
  createdBy    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  collection   Collection? @relation(fields: [collectionId], references: [id])
  model        Model?      @relation(fields: [modelId], references: [id])

  @@index([category])
  @@index([scope])
  @@index([collectionId])
  @@index([modelId])
  @@index([date])
}

model ProductionBatch {
  id             String             @id @default(cuid())
  batchNumber    String             @unique
  modelId        String
  plannedQty     Int
  producedQty    Int                @default(0)
  wasteQty       Int                @default(0)
  status         String             @default("PLANNED")
  materialsCost  Decimal            @default(0)
  laborCost      Decimal            @default(0)
  overheadCost   Decimal            @default(0)
  totalCost      Decimal            @default(0)
  costPerUnit    Decimal            @default(0)
  plannedDate    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  costSnapshotId String?            @unique
  notes          String?
  createdBy      String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  consumptions   BatchConsumption[]
  model          Model              @relation(fields: [modelId], references: [id])

  @@index([modelId])
  @@index([status])
  @@index([batchNumber])
}

model BatchConsumption {
  id              String          @id @default(cuid())
  batchId         String
  inventoryItemId String
  plannedQty      Decimal
  actualQty       Decimal         @default(0)
  unitCost        Decimal
  totalCost       Decimal
  createdAt       DateTime        @default(now())
  batch           ProductionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem   @relation(fields: [inventoryItemId], references: [id])

  @@index([batchId])
  @@index([inventoryItemId])
}

model CostSnapshot {
  id               String   @id @default(cuid())
  snapshotNumber   String   @unique
  modelId          String
  batchId          String?
  fabricCost       Decimal  @default(0)
  accessoryCost    Decimal  @default(0)
  packagingCost    Decimal  @default(0)
  materialsCost    Decimal  @default(0)
  laborCost        Decimal  @default(0)
  atelierCost      Decimal  @default(0)
  productionCost   Decimal  @default(0)
  adsCost          Decimal  @default(0)
  shootingCost     Decimal  @default(0)
  influencerCost   Decimal  @default(0)
  marketingCost    Decimal  @default(0)
  transportCost    Decimal  @default(0)
  otherCost        Decimal  @default(0)
  returnMargin     Decimal  @default(150)
  totalCost        Decimal  @default(0)
  suggestedPrice30 Decimal?
  suggestedPrice40 Decimal?
  suggestedPrice50 Decimal?
  sellingPrice     Decimal?
  margin           Decimal?
  marginPercent    Decimal?
  estimatedUnits   Int      @default(1)
  isLocked         Boolean  @default(true)
  notes            String?
  createdBy        String?
  createdAt        DateTime @default(now())
  model            Model    @relation(fields: [modelId], references: [id])

  @@index([modelId])
  @@index([batchId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  userId    String?
  userEmail String?
  before    String?
  after     String?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
}

model StockReconciliation {
  id              String    @id @default(cuid())
  reconcileDate   DateTime  @default(now())
  inventoryItemId String
  expectedQty     Decimal
  actualQty       Decimal
  variance        Decimal
  variancePercent Decimal
  varianceValue   Decimal
  status          String    @default("PENDING")
  adjustmentId    String?
  reviewedBy      String?
  reviewedAt      DateTime?
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([inventoryItemId])
  @@index([status])
  @@index([reconcileDate])
}

model AccountingSettings {
  id                   String   @id @default("default")
  defaultMarginTarget  Decimal  @default(40)
  defaultReturnMargin  Decimal  @default(150)
  defaultWasteFactor   Decimal  @default(1.05)
  lowStockAlertEnabled Boolean  @default(true)
  autoReconcileEnabled Boolean  @default(false)
  reconcileFrequency   String   @default("DAILY")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model User {
  id                    String           @id @default(cuid())
  name                  String?
  email                 String           @unique
  password              String?
  phone                 String?
  role                  String           @default("USER")
  birthDate             DateTime?
  lastBirthdayGrantYear Int?             @default(0)
  loyaltyPoints         Int              @default(0)
  vipLevel              String           @default("SILVER")
  isEmailVerified       Boolean          @default(false)
  createdVia            String           @default("MANUAL")
  guestKey              String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  pointHistory          LoyaltyPoint[]
  magicLinks            MagicLinkToken[]
  orders                Order[]
  siteSettings          SiteSetting[]    @relation("SiteSettingsUpdater")
  wishlist              WishlistItem[]

  @@index([email])
  @@index([guestKey])
}

model MagicLinkToken {
  id         String    @id @default(cuid())
  tokenHash  String    @unique
  email      String
  userId     String?
  reference  String?
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([tokenHash])
}

model LoyaltyPoint {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  reason      String
  referenceId String?  @unique
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LoyaltyReward {
  id            String   @id @default(cuid())
  nameFr        String
  nameAr        String
  descriptionFr String?
  descriptionAr String?
  cost          Int
  type          String
  value         Decimal?
  productId     String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model SiteSetting {
  id                       String    @id @default("default")
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  heroImageUrl             String?
  heroImagePublicId        String?
  heroMobileImageUrl       String?
  heroMobilePublicId       String?
  heroAltFr                String?
  heroAltAr                String?
  heroCaptionFr            String?
  heroCaptionAr            String?
  heroCtaTextFr            String?
  heroCtaTextAr            String?
  heroCtaUrl               String?
  heroOverlayOpacity       Float?    @default(0.35)
  heroPreset               String?   @default("classic")
  heroActive               Boolean   @default(true)
  heroScheduleStart        DateTime?
  heroScheduleEnd          DateTime?
  heroVariant              String?   @default("image")
  heroCarouselItems        String?
  lastUpdatedById          String?
  featuredBadgeAr          String?
  featuredBadgeFr          String?
  featuredCtaUrl           String?
  featuredDescAr           String?
  featuredDescFr           String?
  featuredImagePublicId    String?
  featuredImageUrl         String?
  featuredTitleAr          String?
  featuredTitleFr          String?
  aboutHeroSubtitle        String?
  aboutHeroTitle           String?
  aboutImage1Url           String?
  aboutImage2Url           String?
  aboutImage3Url           String?
  aboutQuote               String?
  aboutQuoteAuthor         String?
  aboutStoryP1             String?
  aboutStoryP2             String?
  aboutStoryP3             String?
  aboutStoryTitle          String?
  homepageCollectionIds    String?   // JSON array of collection IDs for homepage
  freeShippingPromoEnabled Boolean   @default(false)
  promoCountdownEnabled    Boolean   @default(true)
  lastUpdatedBy            User?     @relation("SiteSettingsUpdater", fields: [lastUpdatedById], references: [id])
}

model SiteSettingHistory {
  id        String   @id @default(cuid())
  settingId String   @default("default")
  snapshot  String
  userId    String?
  createdAt DateTime @default(now())

  @@index([settingId])
  @@index([createdAt])
}

model BlogPost {
  id          String    @id @default(cuid())
  slug        String    @unique
  titleFr     String
  titleAr     String
  excerptFr   String?
  excerptAr   String?
  contentFr   String
  contentAr   String
  coverImage  String?
  category    String    @default("STYLE")
  tags        String?
  authorName  String    @default("L'Équipe Harp")
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  seoTitleFr  String?
  seoTitleAr  String?
  seoDescFr   String?
  seoDescAr   String?
  views       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([category])
  @@index([publishedAt])
}

model BackInStockAlert {
  id          String   @id @default(cuid())
  email       String
  productId   String
  variantInfo String?
  isNotified  Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([email, productId])
  @@index([productId])
  @@index([isNotified])
}

model ReferralCode {
  id              String   @id @default(cuid())
  code            String   @unique
  userId          String
  discountPercent Int      @default(10)
  rewardPoints    Int      @default(500)
  usageCount      Int      @default(0)
  maxUsage        Int      @default(50)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([userId])
}
